"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMainPlugin = void 0;
const utils_1 = require("@vuepress/utils");
const history = require("connect-history-api-fallback");
const resolveAlias_1 = require("./resolveAlias");
const resolveDefine_1 = require("./resolveDefine");
const createMainPlugin = ({ app, options, isBuild, isServer, }) => ({
    name: 'vuepress:main',
    config: async () => {
        // create a temp index.html as dev entry point
        if (!isBuild) {
            await app.writeTemp('vite-root/index.html', utils_1.fs
                .readFileSync(app.options.templateDev)
                .toString()
                .replace(/<\/body>/, `\
<script type="module">
import '@vuepress/client/app'
</script>
</body>`));
        }
        return {
            root: app.dir.temp('vite-root'),
            base: app.options.base,
            mode: isBuild ? 'production' : 'development',
            define: await (0, resolveDefine_1.resolveDefine)({ app, isServer }),
            publicDir: app.dir.public(),
            cacheDir: app.dir.cache(),
            resolve: {
                alias: await (0, resolveAlias_1.resolveAlias)({ app, isServer }),
            },
            css: {
                postcss: {
                    plugins: isServer ? [] : [require('autoprefixer')],
                },
                preprocessorOptions: {
                    scss: { charset: false },
                },
            },
            server: {
                host: app.options.host,
                port: app.options.port,
                open: app.options.open,
            },
            build: {
                ssr: isServer,
                outDir: isServer ? app.dir.dest('.server') : app.dir.dest(),
                emptyOutDir: false,
                cssCodeSplit: false,
                rollupOptions: {
                    input: app.dir.client('dist/app.js'),
                    preserveEntrySignatures: 'allow-extension',
                },
                minify: isServer ? false : !app.env.isDebug,
            },
            optimizeDeps: {
                include: ['@vuepress/shared'],
                // packages that include client code, which should not be optimized
                exclude: [
                    '@vuepress/client',
                    ...app.pluginApi.plugins.map(({ name }) => name),
                ],
            },
            // bundle all dependencies except vue in ssr mode:
            // - transform esm modules to cjs, otherwise we may wrongly `require()` esm modules
            // - bundle dependencies all together, otherwise we may fail to resolve them with pnpm
            // - force externalize vue, because we need to `require('vue')` in node side for ssr usage,
            //   then we also need vue as peer-dependency when using pnpm
            ssr: {
                external: ['vue'],
                noExternal: [/^(?!(vue)$).*$/],
            },
        };
    },
    generateBundle(_, bundle) {
        // delete all asset outputs in server build
        if (isServer) {
            Object.keys(bundle).forEach((key) => {
                if (bundle[key].type === 'asset') {
                    delete bundle[key];
                }
            });
        }
    },
    configureServer(server) {
        return () => {
            // fallback all `.html` requests to `/index.html`
            server.middlewares.use(history({
                rewrites: [
                    {
                        from: /\.html$/,
                        to: '/index.html',
                    },
                ],
            }));
        };
    },
});
exports.createMainPlugin = createMainPlugin;
