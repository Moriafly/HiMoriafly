"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderPage = void 0;
const utils_1 = require("@vuepress/utils");
const renderPagePrefetchLinks_1 = require("./renderPagePrefetchLinks");
const renderPagePreloadLinks_1 = require("./renderPagePreloadLinks");
const renderPageScripts_1 = require("./renderPageScripts");
const renderPageStyles_1 = require("./renderPageStyles");
const resolvePageChunkFiles_1 = require("./resolvePageChunkFiles");
const renderPage = async ({ app, page, vueApp, vueRouter, ssrTemplate, output, outputEntryChunk, outputCssAsset, }) => {
    // switch to current page route
    await vueRouter.push(page.path);
    await vueRouter.isReady();
    // create vue ssr context with default values
    const ssrContext = {
        lang: 'en',
        head: [],
    };
    // render current page to string
    const pageRendered = await require('vue/server-renderer').renderToString(vueApp, ssrContext);
    // resolve page chunks
    const pageChunkFiles = (0, resolvePageChunkFiles_1.resolvePageChunkFiles)({ page, output });
    // generate html string
    const html = ssrTemplate
        // vuepress version
        .replace('{{ version }}', app.version)
        // page lang
        .replace('{{ lang }}', ssrContext.lang)
        // page head
        .replace('<!--vuepress-ssr-head-->', ssrContext.head.map(utils_1.renderHead).join(''))
        // page preload & prefetch links
        .replace('<!--vuepress-ssr-resources-->', `${(0, renderPagePreloadLinks_1.renderPagePreloadLinks)({
        app,
        outputEntryChunk,
        pageChunkFiles,
    })}${(0, renderPagePrefetchLinks_1.renderPagePrefetchLinks)({
        app,
        outputEntryChunk,
        pageChunkFiles,
    })}`)
        // page styles
        .replace('<!--vuepress-ssr-styles-->', (0, renderPageStyles_1.renderPageStyles)({ app, outputCssAsset }))
        // page content
        // notice that some special chars in string like `$&` would be recognized by `replace()`,
        // and they won't be html-escaped and will be kept as is when they are inside a code block,
        // so we use a replace function as the second param to avoid those potential issues
        .replace('<!--vuepress-ssr-app-->', () => pageRendered)
        // page scripts
        .replace('<!--vuepress-ssr-scripts-->', (0, renderPageScripts_1.renderPageScripts)({ app, outputEntryChunk }));
    // write html file
    await utils_1.fs.outputFile(page.htmlFilePath, html);
};
exports.renderPage = renderPage;
