"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.extractTitlePlugin = void 0;
const utils_1 = require("../utils");
/**
 * Extracting markdown title to env
 */
const extractTitlePlugin = (md) => {
    let title;
    // push the rule to the end of the chain
    // resolve title from the parsed tokens
    md.core.ruler.push('resolveExtractTitle', (state) => {
        const tokenIdx = state.tokens.findIndex((token) => token.tag === 'h1');
        if (tokenIdx > -1) {
            title = (0, utils_1.resolveTitleFromToken)(state.tokens[tokenIdx + 1], {
                escapeText: false,
                allowHtml: false,
            });
        }
        else {
            title = '';
        }
        return true;
    });
    // extract title to env
    const render = md.render.bind(md);
    md.render = (src, env = {}) => {
        var _a, _b;
        const result = render(src, env);
        env.title = (_b = (_a = env.frontmatter) === null || _a === void 0 ? void 0 : _a.title) !== null && _b !== void 0 ? _b : title;
        return result;
    };
};
exports.extractTitlePlugin = extractTitlePlugin;
