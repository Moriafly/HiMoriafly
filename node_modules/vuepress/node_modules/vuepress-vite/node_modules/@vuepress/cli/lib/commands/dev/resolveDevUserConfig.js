"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveDevUserConfig = void 0;
const os = require("os");
const path_1 = require("path");
const config_1 = require("../../config");
/**
 * The key of `require.cache` is using backslash as separator on win32
 */
const normalizeRequireCacheKey = (key) => os.platform() === 'win32' ? path_1.win32.normalize(key) : key;
/**
 * Resolve dependencies of a file if the file has been required
 * as a Node.js Module
 */
const resolveDeps = (filename, deps = new Set(), seen = new Set()) => {
    // check if the file has been required as a module
    const mod = require.cache[normalizeRequireCacheKey(filename)];
    if (!mod)
        return deps;
    // check if the file has been seen
    if (seen.has(filename))
        return deps;
    seen.add(filename);
    // recursively resolve deps
    mod.children.forEach(({ id }) => {
        // exclude external modules
        if (!id.includes('node_modules')) {
            deps.add(id);
            resolveDeps(id, deps, seen);
        }
    });
    return deps;
};
/**
 * Load user config file and resolve its dependencies
 */
const resolveDevUserConfig = async (userConfigPath) => {
    if (!userConfigPath) {
        return {
            userConfig: {},
            userConfigDeps: [],
        };
    }
    // clear cache to ensure user config could be reloaded correctly on changed
    resolveDeps(userConfigPath).forEach((item) => {
        delete require.cache[normalizeRequireCacheKey(item)];
    });
    delete require.cache[normalizeRequireCacheKey(userConfigPath)];
    const userConfig = await (0, config_1.loadUserConfig)(userConfigPath);
    const userConfigDeps = Array.from(resolveDeps(userConfigPath));
    return {
        userConfig,
        userConfigDeps,
    };
};
exports.resolveDevUserConfig = resolveDevUserConfig;
